name: Run Django Tests with Coverage

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read
  pull-requests: write

jobs:
  tests:
    runs-on: ubuntu-latest
    # Run on pull requests OR on push events that are not part of a pull request
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && !github.event.pull_request)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.x"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests with coverage
        run: |
          coverage run --concurrency=multiprocessing manage.py test --parallel=auto
          exit_code=$?
          if [ "$exit_code" -eq 5 ]; then
            echo "No tests found - assuming as 100% coverage"
            exit 0
          elif [ "$exit_code" -eq 0 ]; then
            echo "All tests passed"
          else
            echo "Tests failed with exit code $exit_code"
            exit $exit_code
          fi

      - name: Generate report and verify minimum 80% coverage
        run: |
          coverage combine
          coverage report -m --fail-under=80 | tee coverage-report.txt
          coverage xml

      - name: Upload coverage.xml (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
          if-no-files-found: ignore

      - name: Generate PR comment
        if: github.event_name == 'pull_request'
        id: coverage-report
        run: |
          echo "Generating PR comment..."

          # Extract coverage percentage from the report
          COVERAGE_PERCENT=$(grep "TOTAL" coverage-report.txt | awk '{print $NF}' || echo "0%")
          COVERAGE_NUM=$(echo $COVERAGE_PERCENT | sed 's/%//')

          # Determine status emoji and message
          if [ $(echo "$COVERAGE_NUM >= 90" | bc -l) -eq 1 ]; then
            STATUS="‚úÖ Excellent coverage!"
            EMOJI="üéâ"
          elif [ $(echo "$COVERAGE_NUM >= 80" | bc -l) -eq 1 ]; then
            STATUS="‚úÖ Good coverage!"
            EMOJI="üëç"
          elif [ $(echo "$COVERAGE_NUM >= 70" | bc -l) -eq 1 ]; then
            STATUS="‚ö†Ô∏è Coverage is below 80%"
            EMOJI="‚ö†Ô∏è"
          else
            STATUS="‚ùå Coverage is critically low"
            EMOJI="üö®"
          fi

          # Get coverage details (limit to 40 lines)
          COVERAGE_DETAILS=$(cat coverage-report.txt | head -n 40)

          # Check if there are more lines
          TOTAL_LINES=$(wc -l < coverage-report.txt)
          if [ "$TOTAL_LINES" -gt 40 ]; then
            TRUNCATE_MSG="

          ...(truncated, see full report in artifacts)"
          else
            TRUNCATE_MSG=""
          fi

          # Create comment body
          cat > comment.txt << 'EOF'
          ## üìä Test Coverage Report

          **Overall Coverage:** $COVERAGE_PERCENT $EMOJI

          $STATUS

          <details>
          <summary>Click to see detailed coverage report</summary>

          ```
          $COVERAGE_DETAILS$TRUNCATE_MSG
          ```
          </details>

          ---
          üìà Minimum required coverage: **80%**
          EOF

          # Replace variables
          sed -i "s|\$COVERAGE_PERCENT|$COVERAGE_PERCENT|g" comment.txt
          sed -i "s|\$EMOJI|$EMOJI|g" comment.txt
          sed -i "s|\$STATUS|$STATUS|g" comment.txt
          sed -i "s|\$COVERAGE_DETAILS|$COVERAGE_DETAILS|g" comment.txt
          sed -i "s|\$TRUNCATE_MSG|$TRUNCATE_MSG|g" comment.txt

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.txt', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üìä Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
