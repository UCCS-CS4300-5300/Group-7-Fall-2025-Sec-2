{% extends "base.html" %}
{% load static %}

{% block title %}{{ group.name }} - GroupGo{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Group Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h1 class="fw-bold mb-2">{{ group.name }}</h1>
                            <p class="text-muted mb-3">{{ group.description }}</p>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong><i class="fas fa-users"></i> Members:</strong><br>
                                    {{ group.member_count }}/{{ group.max_members }}
                                </div>
                                <div class="col-md-3">
                                    <strong><i class="fas fa-key"></i> Group Code:</strong><br>
                                    <code class="bg-light px-2 py-1 rounded">{{ group_code }}</code>
                                </div>
                                <div class="col-md-3">
                                    <strong><i class="fas fa-lock"></i> Password Protected:</strong><br>
                                    <span class="badge bg-warning">Yes</span>
                                </div>
                                <div class="col-md-3">
                                    <strong><i class="fas fa-clock"></i> Created:</strong><br>
                                    {{ group.created_at|date:"M d, Y" }}
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            {% if user_is_member %}
                                {% if user_role == 'admin' %}
                                    <span class="badge bg-warning mb-2">Admin</span><br>
                                    <a href="{% url 'travel_groups:group_settings' group.id %}" class="btn btn-outline-warning btn-sm">
                                        <i class="fas fa-cog"></i> Settings
                                    </a>
                                {% else %}
                                    <span class="badge bg-success mb-2">Member</span><br>
                                    <a href="{% url 'travel_groups:leave_group' group.id %}" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-sign-out-alt"></i> Leave Group
                                    </a>
                                {% endif %}
                            {% else %}
                                {% if not group.is_full %}
                                    <a href="{% url 'travel_groups:join_group' %}" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i> Join Group
                                    </a>
                                {% else %}
                                    <span class="badge bg-danger">Group Full</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
                <i class="fas fa-users"></i> Members ({{ members.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="itineraries-tab" data-bs-toggle="tab" data-bs-target="#itineraries" type="button" role="tab">
                <i class="fas fa-route"></i> Trips ({{ group_itineraries.count }})
            </button>
        </li>
        {% if user_is_member %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="trip-management-tab" data-bs-toggle="tab" data-bs-target="#trip-management" type="button" role="tab">
                <i class="fas fa-plus"></i> Find A Trip
            </button>
        </li>
        {% endif %}
        {% if user_is_member %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab">
                <i class="fas fa-heart"></i> My Preferences
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="trip-preferences-tab" data-bs-toggle="tab" data-bs-target="#trip-preferences" type="button" role="tab">
                <i class="fas fa-map-marked-alt"></i> Trip Preferences
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="groupTabsContent">
        <!-- Members Tab -->
        <div class="tab-pane fade show active" id="members" role="tabpanel">
            <div class="row">
                {% for member in members %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        {{ member.user.first_name|first|default:member.user.username|first|upper }}
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">{{ member.user.get_full_name|default:member.user.username }}</h6>
                                    <small class="text-muted">
                                        {% if member.role == 'admin' %}
                                            <span class="badge bg-warning">Admin</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Member</span>
                                        {% endif %}
                                        {% if member.has_travel_preferences %}
                                            <span class="badge bg-info ms-1">Has Preferences</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No members found.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Trips Tab (Shows Voting Options or Regular Trips) -->
        <div class="tab-pane fade" id="itineraries" role="tabpanel">
            {% if voting_options %}
            <!-- Voting Options Available -->
            <div class="alert {% if is_unanimous %}alert-success{% else %}alert-info{% endif %} mb-4">
                <h5 class="alert-heading"><i class="fas fa-vote-yea"></i> Voting in Progress!</h5>
                {% if is_unanimous %}
                    <p class="mb-2"><strong>üéâ Unanimous Vote!</strong> All members voted for this option!</p>
                {% else %}
                    <p>AI has generated multiple trip options. One option is shown at a time. Cast your vote below!</p>
                {% endif %}
                <p class="mb-1"><strong>{{ votes_cast }} of {{ members.count }}</strong> members have voted.</p>
                {% if pending_count %}
                    <p class="mb-0"><small><i class="fas fa-clock"></i> {{ pending_count }} option{{ pending_count|pluralize }} waiting</small></p>
                {% endif %}
                {% if rejected_count %}
                    <p class="mb-0"><small><i class="fas fa-times-circle"></i> {{ rejected_count }} option{{ rejected_count|pluralize }} rejected</small></p>
                {% endif %}
            </div>
            
            <div class="row justify-content-center">
                {% for option_data in voting_options %}
                {% with option=option_data.option activities=option_data.activities %}
                <div class="col-lg-6 col-xl-5 mb-4">
                    <div class="card h-100 {% if user_vote and user_vote.option == option %}border-success border-3{% else %}border-primary{% endif %}">
                        <div class="card-header {% if option.option_letter == 'A' %}bg-info{% elif option.option_letter == 'B' %}bg-primary{% else %}bg-info{% endif %} text-white text-center">
                            <h5 class="mb-0">
                                {% if option.destination %}
                                    A Trip to {{ option.destination }}
                                {% else %}
                                    Option {{ option.option_letter }}
                                {% endif %}
                            </h5>
                            <small class="d-block mt-1">{{ option.vote_count }} vote{{ option.vote_count|pluralize }}</small>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">{{ option.title }}</h6>
                            <p class="card-text">{{ option.description }}</p>
                            
                            {% if option.destination %}
                            <div class="alert alert-info mb-2 text-center">
                                <strong>üìç Destination:</strong> {{ option.destination }}
                            </div>
                            {% endif %}
                            {% if option.search %}
                            <div class="alert alert-light mb-3 text-center">
                                <strong>üìÖ Travel Dates:</strong> {{ option.search.start_date|date:"M d, Y" }} - {{ option.search.end_date|date:"M d, Y" }}
                            </div>
                            {% endif %}
                            
                            <hr>
                            
                            {% if option.selected_flight %}
                            <h6 class="mb-2">‚úàÔ∏è Flight</h6>
                            <p class="small">
                                <strong>{{ option.selected_flight.airline }}</strong><br>
                                ${{ option.selected_flight.price }}
                                {% if option.selected_flight.currency and option.selected_flight.currency != 'USD' %}{{ option.selected_flight.currency }}{% endif %}<br>
                                {% if option.selected_flight.duration %}
                                <i class="far fa-clock"></i> {{ option.selected_flight.duration }}<br>
                                {% endif %}
                                {% if option.selected_flight.departure_time %}
                                <i class="far fa-calendar-alt"></i> Departs: {{ option.selected_flight.departure_time|date:"M d, Y g:i A" }}<br>
                                {% endif %}
                                {% if option.selected_flight.arrival_time %}
                                <i class="far fa-calendar-check"></i> Arrives: {{ option.selected_flight.arrival_time|date:"M d, Y g:i A" }}<br>
                                {% endif %}
                                {% if option.search and option.search.origin and option.selected_flight.searched_destination %}
                                <i class="fas fa-route"></i> {{ option.search.origin }} ‚Üí {{ option.selected_flight.searched_destination }}<br>
                                {% endif %}
                                <i class="fas fa-plane"></i> {{ option.selected_flight.stops }} stop{{ option.selected_flight.stops|pluralize }}
                            </p>
                            {% endif %}
                            
                            {% if option.selected_hotel %}
                            <h6 class="mb-2">üè® Hotel</h6>
                            <p class="small">
                                <strong>{{ option.selected_hotel.name }}</strong><br>
                                ${{ option.selected_hotel.total_price }} total
                                {% if option.selected_hotel.rating %} | ‚≠ê {{ option.selected_hotel.rating }}/5{% endif %}
                                {% if option.selected_hotel.room_type %}<br><i class="fas fa-bed"></i> {{ option.selected_hotel.room_type }}{% endif %}
                                {% if option.selected_hotel.breakfast_included %}<br><span class="badge badge-info">Breakfast Included</span>{% endif %}
                            </p>
                            {% endif %}
                            
                            {% if activities %}
                            <h6 class="mb-2">üé≠ Activities ({{ activities|length }})</h6>
                            <ul class="small ps-3">
                                {% for activity in activities|slice:":3" %}
                                <li>{{ activity.name }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            
                            <hr>
                            
                            <div class="text-center mb-3">
                                <h4 class="text-primary mb-0">${{ option.estimated_total_cost }}</h4>
                                <small class="text-muted">${{ option.cost_per_person }} per person</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="row g-2">
                                <div class="col-6">
                                    <button type="button" class="btn {% if user_vote and user_vote.option == option %}btn-success{% else %}btn-success{% endif %} btn-lg w-100" onclick="letsGo('{{ option.id }}', '{{ option.option_letter }}')">
                                        <i class="fas fa-check-circle"></i> Let's Go
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-outline-secondary btn-lg w-100 roll-again-btn" data-option-id="{{ option.id }}" data-option-letter="{{ option.option_letter }}" onclick="rollAgain('{{ option.id }}', '{{ option.option_letter }}'); return false;">
                                        <i class="fas fa-redo"></i> Roll Again
                                    </button>
                                </div>
                            </div>
                            {% if user_vote %}
                                <div class="text-center mt-2">
                                    {% if user_vote.option == option %}
                                        {% if user_vote.comment == "ROLL_AGAIN" %}
                                            <small class="text-warning"><i class="fas fa-redo"></i> You voted "Roll Again"</small>
                                        {% else %}
                                            <small class="text-success"><i class="fas fa-check"></i> You voted "Let's Go"</small>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            
            {% if voting_complete %}
            <div class="text-center mt-4">
                {% if is_unanimous %}
                    <div class="alert alert-success">
                        <h5>üéâ Trip Selected!</h5>
                        <p>This option received unanimous approval from all group members!</p>
                        <a href="{% url 'ai_implementation:voting_results' group.id %}" class="btn btn-success btn-lg mt-2">
                            <i class="fas fa-trophy"></i> View Selected Trip
                        </a>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <h5>Not Unanimous</h5>
                        <p>This option did not receive unanimous approval. You can try the next option.</p>
                        <button class="btn btn-primary btn-lg mt-2" onclick="advanceToNextOption()">
                            <i class="fas fa-arrow-right"></i> Try Next Option
                        </button>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            {% else %}
            <!-- Regular Trips View (when no voting in progress) -->
            <div class="row">
                {% for group_itinerary in group_itineraries %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">{{ group_itinerary.itinerary.title }}</h6>
                            <p class="card-text">{{ group_itinerary.itinerary.description|truncatewords:15 }}</p>
                            <div class="mb-2">
                                <strong>Destination:</strong> {{ group_itinerary.itinerary.destination }}
                            </div>
                            <div class="mb-2">
                                <strong>Dates:</strong> 
                                {{ group_itinerary.itinerary.start_date|date:"M d" }} - 
                                {{ group_itinerary.itinerary.end_date|date:"M d, Y" }}
                            </div>
                            <small class="text-muted">
                                Added by {{ group_itinerary.added_by.get_full_name|default:group_itinerary.added_by.username }}
                                on {{ group_itinerary.added_at|date:"M d, Y" }}
                            </small>
                            {% if group_itinerary.is_approved %}
                                <span class="badge bg-success ms-1">Approved</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-4">
                        <i class="fas fa-route fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No trips added yet.</p>
                        {% if user_is_member %}
                            <p class="text-muted">Use the "Find A Trip" tab to find your perfect trip with AI!</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Trip Management Tab -->
        {% if user_is_member %}
        <div class="tab-pane fade" id="trip-management" role="tabpanel">
            <!-- Find Your Trip Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-magic"></i> AI-Powered Trip Finder</h5>
                        </div>
                        <div class="card-body text-center py-5">
                            <i class="fas fa-robot fa-4x text-primary mb-4"></i>
                            <h4 class="mb-3">Find Your Perfect Group Trip!</h4>
                            <p class="lead mb-2">Let AI analyze your group's preferences and create 3 custom itinerary options</p>
                            <p class="text-muted mb-4">Using real flight data from SerpAPI and smart recommendations from OpenAI</p>
                            
                            <div class="alert alert-info d-inline-block text-start">
                                <strong>üìä Group Status:</strong><br>
                                <span class="ms-3">Total Members: {{ members.count }}</span><br>
                                <span class="ms-3">Members with Preferences: {{ prefs_count }}</span>
                            </div>
                            
                            <div class="mt-4">
                                {% if prefs_count >= 2 %}
                                <button class="btn btn-success btn-lg px-5" onclick="findYourTrip()">
                                    <i class="fas fa-magic"></i> Find Your Trip
                                </button>
                                <p class="text-muted mt-2 small">This will generate AI-curated options for your group to vote on</p>
                                {% else %}
                                <div class="alert alert-warning">
                                    <strong>‚ö†Ô∏è Need More Preferences!</strong><br>
                                    At least 2 members need to submit their trip preferences before AI can generate options.
                                </div>
                                <a href="{% url 'travel_groups:add_trip_preferences' group.id %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Your Preferences
                                </a>
                                {% endif %}
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="row text-start">
                                <div class="col-md-4">
                                    <div class="p-3">
                                        <h6><i class="fas fa-check-circle text-success"></i> Step 1</h6>
                                        <p class="small">All members submit their trip preferences</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3">
                                        <h6><i class="fas fa-magic text-primary"></i> Step 2</h6>
                                        <p class="small">AI searches flights & hotels, creates 3 options</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3">
                                        <h6><i class="fas fa-vote-yea text-warning"></i> Step 3</h6>
                                        <p class="small">Members vote on their favorite option</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group Trips Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-route"></i> Group Trips ({{ group_itineraries.count }})</h5>
                        </div>
                        <div class="card-body">
                            {% if group_itineraries %}
                                <div class="row">
                                    {% for group_itinerary in group_itineraries %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">{{ group_itinerary.itinerary.title }}</h6>
                                                <p class="card-text">{{ group_itinerary.itinerary.description|truncatewords:15 }}</p>
                                                <div class="mb-2">
                                                    <strong>Destination:</strong> {{ group_itinerary.itinerary.destination }}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Dates:</strong> 
                                                    {{ group_itinerary.itinerary.start_date|date:"M d" }} - 
                                                    {{ group_itinerary.itinerary.end_date|date:"M d, Y" }}
                                                </div>
                                                <small class="text-muted">
                                                    Added by {{ group_itinerary.added_by.get_full_name|default:group_itinerary.added_by.username }}
                                                    on {{ group_itinerary.added_at|date:"M d, Y" }}
                                                </small>
                                                {% if group_itinerary.is_approved %}
                                                    <span class="badge bg-success ms-1">Approved</span>
                                                {% endif %}
                                            </div>
                                            <div class="card-footer bg-light">
                                                {% if user_role == 'admin' or group_itinerary.added_by.id == user.id %}
                                                <div class="btn-group w-100" role="group">
                                                    <button class="btn btn-primary btn-sm" onclick="editTrip('{{ group_itinerary.itinerary.id }}', '{{ group_itinerary.itinerary.title|escapejs }}', '{{ group_itinerary.itinerary.description|escapejs }}', '{{ group_itinerary.itinerary.destination|escapejs }}', '{{ group_itinerary.itinerary.start_date|date:"Y-m-d" }}', '{{ group_itinerary.itinerary.end_date|date:"Y-m-d" }}')" style="width: 50%;">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteTrip({{ group_itinerary.itinerary.id }}, '{{ group_itinerary.itinerary.title|escapejs }}')" style="width: 50%;">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                                {% else %}
                                                <small class="text-muted d-block text-center">Only admin or creator can edit/delete</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-route fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No trips created yet for this group.</p>
                                    <p class="text-muted">Create your first trip using the form above!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Preferences Tab -->
        {% if user_is_member %}
        <div class="tab-pane fade" id="preferences" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Travel Preferences</h5>
                        </div>
                        <div class="card-body">
                            {% if travel_preferences %}
                                <div class="row">
                                    {% if travel_preferences.budget_range %}
                                    <div class="col-md-6 mb-3">
                                        <strong>Budget Range:</strong><br>
                                        {{ travel_preferences.budget_range }}
                                    </div>
                                    {% endif %}
                                    {% if travel_preferences.accommodation_preference %}
                                    <div class="col-md-6 mb-3">
                                        <strong>Accommodation:</strong><br>
                                        {{ travel_preferences.accommodation_preference }}
                                    </div>
                                    {% endif %}
                                    {% if travel_preferences.activity_preferences %}
                                    <div class="col-12 mb-3">
                                        <strong>Activity Preferences:</strong><br>
                                        {{ travel_preferences.activity_preferences }}
                                    </div>
                                    {% endif %}
                                    {% if travel_preferences.dietary_restrictions %}
                                    <div class="col-12 mb-3">
                                        <strong>Dietary Restrictions:</strong><br>
                                        {{ travel_preferences.dietary_restrictions }}
                                    </div>
                                    {% endif %}
                                    {% if travel_preferences.accessibility_needs %}
                                    <div class="col-12 mb-3">
                                        <strong>Accessibility Needs:</strong><br>
                                        {{ travel_preferences.accessibility_needs }}
                                    </div>
                                    {% endif %}
                                    {% if travel_preferences.notes %}
                                    <div class="col-12 mb-3">
                                        <strong>Additional Notes:</strong><br>
                                        {{ travel_preferences.notes }}
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="text-muted">You haven't set your travel preferences yet.</p>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'travel_groups:update_preferences' group.id %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> 
                                {% if travel_preferences %}Update{% else %}Set{% endif %} Preferences
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Trip Preferences Tab -->
        {% if user_is_member %}
        <div class="tab-pane fade" id="trip-preferences" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Group Trip Preferences</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">View and manage trip preferences for all group members.</p>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                                <a href="{% url 'travel_groups:add_trip_preferences' group.id %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add My Trip Preferences
                                </a>
                                <a href="{% url 'travel_groups:view_trip_preferences' group.id %}" class="btn btn-outline-info">
                                    <i class="fas fa-eye"></i> View All Preferences
                                </a>
                            </div>
                            
                            <!-- Quick summary of preferences completion -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary">{{ members.count }}</h3>
                                            <p class="text-muted mb-0">Total Members</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-success">0</h3>
                                            <p class="text-muted mb-0">With Trip Preferences</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-warning">0%</h3>
                                            <p class="text-muted mb-0">Completion Rate</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Date Selection Modal for "Find Your Trip" -->
<div class="modal fade" id="dateSelectionModal" tabindex="-1" aria-labelledby="dateSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="dateSelectionModalLabel">
                    <i class="fas fa-calendar"></i> Select Trip Dates
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Select your group's travel dates</strong><br>
                    AI will search for flights and hotels within this date range.
                </div>
                
                <form id="dateSelectionForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="trip_origin" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Starting Location (Airport or City)
                            </label>
                            <div class="position-relative">
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="trip_origin" 
                                       name="origin" 
                                       placeholder="e.g., Denver, DEN, or Denver International Airport"
                                       autocomplete="off"
                                       required>
                                <div id="origin_autocomplete" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                            </div>
                            <small class="text-muted">Where will your trip start? This helps us find real-time flight prices.</small>
                            <input type="hidden" id="trip_origin_code" name="origin_code">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="trip_start_date" class="form-label">
                                <i class="fas fa-plane-departure"></i> Start Date
                            </label>
                            <input type="date" 
                                   class="form-control form-control-lg" 
                                   id="trip_start_date" 
                                   name="start_date" 
                                   required
                                   min="{{ today|date:'Y-m-d' }}">
                            <small class="text-muted">When does your trip start?</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="trip_end_date" class="form-label">
<i class="fas fa-plane-arrival"></i> End Date
                            </label>
                            <input type="date" 
                                   class="form-control form-control-lg" 
                                   id="trip_end_date" 
                                   name="end_date" 
                                   required
                                   min="{{ today|date:'Y-m-d' }}">
                            <small class="text-muted">When does your trip end?</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div id="date_info" class="alert alert-light" style="display: none;">
                                <strong>Trip Duration:</strong> <span id="trip_duration">0</span> days
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-clock"></i> <strong>Note:</strong> Finding your trip with AI will take 30-60 seconds. 
                        We'll search real flights, analyze preferences, and create 3 custom options.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="confirmAndFindTrip()">
                    <i class="fas fa-magic"></i> Find Your Trip
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Trip Modal -->
<div class="modal fade" id="editTripModal" tabindex="-1" aria-labelledby="editTripModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTripModalLabel">
                    <i class="fas fa-edit"></i> Edit Trip
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTripForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit_trip_id" name="trip_id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_title" class="form-label">Trip Title</label>
                            <input type="text" class="form-control" id="edit_title" name="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_destination" class="form-label">Destination</label>
                            <input type="text" class="form-control" id="edit_destination" name="destination" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="edit_start_date" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="edit_end_date" name="end_date" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedTrip()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function findYourTrip() {
    // Open date selection modal instead of immediately starting
    const modal = new bootstrap.Modal(document.getElementById('dateSelectionModal'));
    modal.show();
}

function confirmAndFindTrip() {
    // Get selected dates and origin
    const startDate = document.getElementById('trip_start_date').value;
    const endDate = document.getElementById('trip_end_date').value;
    const origin = document.getElementById('trip_origin_code').value || document.getElementById('trip_origin').value;
    
    // Validate dates
    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }
    
    // Validate origin
    if (!origin || origin.trim() === '') {
        alert('Please select a starting location.');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (end <= start) {
        alert('End date must be after start date.');
        return;
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (start < today) {
        alert('Start date cannot be in the past.');
        return;
    }
    
    // Close the date modal
    bootstrap.Modal.getInstance(document.getElementById('dateSelectionModal')).hide();
    
    // Show loading state
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal fade show';
    loadingModal.style.display = 'block';
    loadingModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <i class="fas fa-robot fa-4x text-primary mb-3"></i>
                    <h4>AI is Finding Your Perfect Trip!</h4>
                    <div class="spinner-border text-primary my-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-2">Searching flights for ${startDate} to ${endDate}</p>
                    <p class="text-muted">This takes 30-60 seconds...</p>
                    <div id="progress-steps" class="mt-3">
                        <small class="text-muted">
                            <span id="step1">üîç Analyzing preferences...</span><br>
                            <span id="step2" style="display:none;">‚úàÔ∏è Searching flights...</span><br>
                            <span id="step3" style="display:none;">üè® Finding hotels...</span><br>
                            <span id="step4" style="display:none;">ü§ñ Creating multiple options...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingModal);
    
    // Animate progress steps
    setTimeout(() => { document.getElementById('step2').style.display = 'block'; }, 5000);
    setTimeout(() => { document.getElementById('step3').style.display = 'block'; }, 15000);
    setTimeout(() => { document.getElementById('step4').style.display = 'block'; }, 25000);
    
    // Make API call with selected dates
    fetch('{% url "ai_implementation:generate_voting_options" group.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            origin: origin
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.remove();
        if (data.success) {
            // Success - force page reload and navigate to Trips tab
            // First set the hash, then force reload
            window.location.hash = 'itineraries';
            window.location.reload(true);  // true = force reload from server, not cache
        } else {
            alert('Error: ' + (data.error || 'Failed to generate options. Please try again.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingModal.remove();
        alert('An error occurred. Please try again.');
    });
}

// Airport autocomplete functionality
let autocompleteTimeout;

function initializeAutocomplete() {
    const originInput = document.getElementById('trip_origin');
    const originCodeInput = document.getElementById('trip_origin_code');
    const autocompleteDiv = document.getElementById('origin_autocomplete');
    
    if (!originInput || !originCodeInput || !autocompleteDiv) {
        return;
    }
    
    originInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        clearTimeout(autocompleteTimeout);
        
        // Hide autocomplete if query is too short
        if (query.length < 2) {
            autocompleteDiv.style.display = 'none';
            originCodeInput.value = '';
            return;
        }
        
        // Debounce the search
        autocompleteTimeout = setTimeout(() => {
            fetch(`{% url "ai_implementation:airport_autocomplete" %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayAutocomplete(data.airports);
                })
                .catch(error => {
                    console.error('Autocomplete error:', error);
                });
        }, 300);
    });
    
    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!originInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
            autocompleteDiv.style.display = 'none';
        }
    });
    
    // Handle keyboard navigation
    originInput.addEventListener('keydown', function(e) {
        const items = autocompleteDiv.querySelectorAll('.list-group-item');
        const activeItem = autocompleteDiv.querySelector('.list-group-item.active');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (activeItem) {
                activeItem.classList.remove('active');
                const next = activeItem.nextElementSibling;
                if (next) {
                    next.classList.add('active');
                    next.scrollIntoView({ block: 'nearest' });
                }
            } else if (items.length > 0) {
                items[0].classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (activeItem) {
                activeItem.classList.remove('active');
                const prev = activeItem.previousElementSibling;
                if (prev) {
                    prev.classList.add('active');
                    prev.scrollIntoView({ block: 'nearest' });
                }
            }
        } else if (e.key === 'Enter' && activeItem) {
            e.preventDefault();
            activeItem.click();
        } else if (e.key === 'Escape') {
            autocompleteDiv.style.display = 'none';
        }
    });
    
    function displayAutocomplete(airports) {
        if (!airports || airports.length === 0) {
            autocompleteDiv.style.display = 'none';
            return;
        }
        
        autocompleteDiv.innerHTML = '';
        
        airports.forEach((airport, index) => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            if (index === 0) {
                item.classList.add('active');
            }
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${airport.display}</h6>
                    <small>${airport.code}</small>
                </div>
                <p class="mb-1 small text-muted">${airport.full_display}</p>
            `;
            item.addEventListener('click', function(e) {
                e.preventDefault();
                originInput.value = airport.display;
                originCodeInput.value = airport.code;
                autocompleteDiv.style.display = 'none';
            });
            autocompleteDiv.appendChild(item);
        });
        
        autocompleteDiv.style.display = 'block';
    }
}

// Calculate trip duration when dates change
document.addEventListener('DOMContentLoaded', function() {
    // Initialize autocomplete
    initializeAutocomplete();
    
    const startInput = document.getElementById('trip_start_date');
    const endInput = document.getElementById('trip_end_date');
    
    if (startInput && endInput) {
        function updateDuration() {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);
            
            if (startInput.value && endInput.value && end > start) {
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                document.getElementById('trip_duration').textContent = days;
                document.getElementById('date_info').style.display = 'block';
            } else {
                document.getElementById('date_info').style.display = 'none';
            }
        }
        
        startInput.addEventListener('change', updateDuration);
        endInput.addEventListener('change', updateDuration);
    }
});

function letsGo(optionId, optionLetter) {
    // Vote "yes" for this option
    fetch(`/ai/group/{{ group.id }}/voting/cast/${optionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'comment='
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Always reload the page after voting
            window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
        } else {
            // Log error to console instead of showing alert
            console.error('Voting error:', data.error || 'Unknown error');
            // Still reload to show updated state
            window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Still reload to show updated state
        window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
    });
}

// Make rollAgain globally accessible
window.rollAgain = function(optionId, optionLetter) {
    console.log('rollAgain called with optionId:', optionId, 'optionLetter:', optionLetter);
    
    if (!optionId) {
        console.error('rollAgain: optionId is missing!');
        // Just return silently - page will show current state
        return;
    }
    
    // Vote "no" - reject this option and advance to next (no confirmation needed)
    const url = `/ai/group/{{ group.id }}/voting/roll-again/${optionId}/`;
    console.log('Making request to:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Always reload the page after voting
            window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
        } else {
            // Log error to console instead of showing alert
            console.error('Roll again error:', data.error || 'Unknown error');
            // Still reload to show updated state
            window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
        }
    })
    .catch(error => {
        console.error('Error in rollAgain:', error);
        // Still reload to show updated state
        window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
    });
};

function advanceToNextOption() {
    if (confirm('Move to the next option? All votes will be reset and members will vote again on the new option.')) {
        fetch(`/ai/group/{{ group.id }}/voting/next/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message + ` (${data.remaining_pending} more option${data.remaining_pending !== 1 ? 's' : ''} available)`);
                // Reload to show new option
                window.location.href = '{% url "travel_groups:group_detail" group.id %}#itineraries';
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while advancing to next option');
        });
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function editTrip(tripId, title, description, destination, startDate, endDate) {
    // Populate the edit form
    document.getElementById('edit_trip_id').value = tripId;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_destination').value = destination;
    document.getElementById('edit_start_date').value = startDate;
    document.getElementById('edit_end_date').value = endDate;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editTripModal'));
    modal.show();
}

function saveEditedTrip() {
    const form = document.getElementById('editTripForm');
    const formData = new FormData(form);
    const tripId = document.getElementById('edit_trip_id').value;
    
    fetch(`/groups/{{ group.id }}/edit-trip/${tripId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('editTripModal')).hide();
            // Reload to show updated trip
            window.location.href = '{% url "travel_groups:group_detail" group.id %}#trip-management';
        } else {
            alert('Error: ' + (data.error || JSON.stringify(data.errors)));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the trip.');
    });
}

function deleteTrip(itineraryId, tripTitle) {
    if (confirm(`Are you sure you want to delete "${tripTitle}" from this group?\n\nNote: This only removes it from the group, not from your personal trips.`)) {
        fetch(`/groups/{{ group.id }}/delete-trip/${itineraryId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload to show updated trip list
                window.location.href = '{% url "travel_groups:group_detail" group.id %}#trip-management';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the trip.');
        });
    }
}

// When page loads with hash, activate appropriate tab
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    console.log('Page loaded with hash:', hash);
    
    // Set up Roll Again button event listeners (backup to onclick)
    document.querySelectorAll('.roll-again-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const optionId = this.getAttribute('data-option-id');
            const optionLetter = this.getAttribute('data-option-letter');
            console.log('Roll Again button clicked (via event listener) for option:', optionId);
            if (typeof rollAgain === 'function') {
                rollAgain(optionId, optionLetter);
            } else {
                console.error('rollAgain function not found!');
                alert('Error: rollAgain function not available. Please refresh the page.');
            }
        });
    });
    
    if (hash === '#trip-management') {
        const tripTab = document.getElementById('trip-management-tab');
        if (tripTab) {
            console.log('Activating trip-management tab');
            const tab = new bootstrap.Tab(tripTab);
            tab.show();
        }
    } else if (hash === '#itineraries') {
        const itinTab = document.getElementById('itineraries-tab');
        if (itinTab) {
            console.log('Activating itineraries tab');
            const tab = new bootstrap.Tab(itinTab);
            tab.show();
            // Scroll to top of page to ensure voting options are visible
            setTimeout(function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }
    }
});
</script>

{% endblock %}
